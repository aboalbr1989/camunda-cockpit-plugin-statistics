<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cockpit.statistics">

	<resultMap id="activityInstanceCountMap"
		type="org.camunda.cockpit.plugin.statistics.dto.activity.ActivityInstanceCountDto">
		<result property="activityName" column="ACT_NAME" />
		<result property="count" column="COUNT" />
		<result property="procDefKey" column="PROC_DEF_KEY" />
		<result property="avgDuration" column="AVG_DURATION" />
		<result property="minDuration" column="MIN_DURATION" />
		<result property="maxDuration" column="MAX_DURATION" />
		<result property="type" column="ACT_TYPE" />
	</resultMap>
	
	 <select id="selectActivityInstanceCountsByProcessDefinition"
    resultMap="activityInstanceCountMap">
	   SELECT
	      ACT_NAME_ as ACT_NAME, 
	      ACT_TYPE_ as ACT_TYPE, 
	      PROC_DEF_KEY_ as PROC_DEF_KEY,
	      <!-- count, min, max, avg, duration -->
        <include refid="cockpit.statistics.commonAggregations"/>
      FROM act_hi_actinst A 
      WHERE
	      ACT_TYPE_ in ('userTask', 'callActivity', 'serviceTask', 'subProcess', 'transaction', 'sendTask', 'receiveTask')
	      AND DURATION_ > 0
	      <if test="parameter != null">
	      AND PROC_DEF_KEY_ = '${parameter}'
	      </if>
	      group by ACT_NAME_, ACT_TYPE_, PROC_DEF_KEY_
	 </select>

  	<resultMap id="activityNameTypeProcessDefinitionMap"
		type="org.camunda.cockpit.plugin.statistics.dto.activity.ActivityInstanceCountDto">
		<result property="activityName" column="ACT_NAME" />
		<result property="procName" column="NAME" />
		<result property="procVersion" column="VERSION" />
		<result property="procDefKey" column="PROC_DEF_KEY" />
		<result property="procDefId" column="PROC_DEF_ID" />
		<result property="type" column="ACT_TYPE" />
	</resultMap>
	
	 <select id="selectActivityNamesTypesProcessDefinition"
    resultMap="activityNameTypeProcessDefinitionMap">
	   SELECT
	      ACT_NAME_ as ACT_NAME, 
	      ACT_TYPE_ as ACT_TYPE, 
	      PROC_DEF_KEY_ as PROC_DEF_KEY,
		  NAME_  as NAME,
		  VERSION_ as VERSION,
	      PROC_DEF_ID_ as 	PROC_DEF_ID  
      FROM act_hi_actinst A 
		LEFT JOIN ACT_RE_PROCDEF def ON def.ID_ = A.PROC_DEF_ID_
      WHERE
	   	  ACT_TYPE_ IS NOT NULL
	  GROUP BY ACT_NAME_, ACT_TYPE_, PROC_DEF_ID_
	  ORDER BY PROC_DEF_KEY, ACT_NAME

	 </select>
	 
</mapper>